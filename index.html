<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>static-md-wiki</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            color: #333;
        }

        #quicklaunch {
            position: fixed;
            top: 0px;
            left: 0px;
            text-decoration: none;
            text-align: center;
            font-size: 24px;
            z-index: 100;
        }
        #quicklaunch:hover {
            opacity: 1.0;
        }
        #quicklaunch a {
            margin-left: 0.3em;
            text-decoration: none;
        }
        @media (hover: hover) {
            #quicklaunch {
                opacity: 0.3;
            }
        }
        @media (max-width: 700px) {
            #quicklaunch {
                left: auto;
                right: 0px;
                text-align: center;
                z-index: 100;
            }
        }

        #navigation {
            text-align: center;
            font-size: x-large;
        }
        #navigation a {
            text-decoration: none;
            margin-right: 2rem;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const INITIAL_PAGE = 'index.md';
        const CONTENT_REL_DIR = 'content/';
        const APP_ROOT = new URL('./', document.baseURI).href;
        const CONTENT_ROOT = new URL(CONTENT_REL_DIR, APP_ROOT).href;
        let currentFileHref = new URL(INITIAL_PAGE, CONTENT_ROOT).href;

        function getRelativePagePath(href) {
            if (href.startsWith('/')) {
                return href.substring(1);
            }

            const out = new URL(href, currentFileHref).toString();
            if (out.startsWith(CONTENT_ROOT)) {
                return out.substring(CONTENT_ROOT.length);
            }
            console.log("dubious href: " + href);
            return href;
        }

        /**
         * Fetches markdown from a URL, renders it, and injects it into the DOM.
         */
        async function loadMarkdown(targetPath, updateHistory = true) {
            const resolvedUrl = new URL(targetPath, currentFileHref);
            const contentDiv = document.getElementById('content');
            const navDiv = document.getElementById('navigation');
            // contentDiv.innerHTML = "Loading content...";

            try {
                const response = await fetch(resolvedUrl, { cache: "no-store"});
                if (!response.ok) throw new Error(`Could not fetch ${resolvedUrl.pathname} [${response.status}: ${response.statusText}]`);

                const markdown = await response.text();

                // Track the current path for the next relative resolution
                // IMPORTANT: Set context BEFORE parsing so renderer uses the new path
                currentFileHref = resolvedUrl.href;

                // Render Markdown using Marked.js
                contentDiv.innerHTML = marked.parse(markdown);

                const filename = targetPath.split("/").at(-1);
                const quarterParts = /^(\d{4})-Q(\d{1}).md$/.exec(filename);
                if (quarterParts) {
                    const theyear = parseInt(quarterParts[1]);
                    const thequarter = parseInt(quarterParts[2]);

                    let prevyear = theyear;
                    let prevquarter = thequarter - 1;
                    if (prevquarter === 0) {
                        prevyear = prevyear - 1;
                        prevquarter = 4;
                    }

                    let nextyear = theyear;
                    let nextquarter = thequarter + 1;
                    if (nextquarter === 5) {
                        nextyear = nextyear + 1;
                        nextquarter = 1;
                    }

                    navDiv.innerHTML = marked.parse(`[⬅ ${prevyear}-Q${prevquarter}](${prevyear}-Q${prevquarter}.md)   [${nextyear}-Q${nextquarter} ⮕](${nextyear}-Q${nextquarter}.md)`);

                    navDiv.style.display = "block";
                } else {
                    navDiv.style.display = "none";
                }

                const cleanTitle = resolvedUrl.pathname.replace(/\.md$/, '');
                document.title = cleanTitle;
            } catch (err) {
                contentDiv.innerHTML = `<p style="color:red">${err.message}</p>`;
                navDiv.style.display = "none";
            } finally {
                if (updateHistory) {
                    const newUrl = `${window.location.pathname}?page=${resolvedUrl.pathname}`;
                    window.history.pushState({ path: resolvedUrl.pathname }, "", newUrl);
                }
                window.scrollTo(0, 0);
            }
        }

        async function loadQuicklaunchBar() {
            const quicklaunchDiv = document.getElementById('quicklaunch');
            try {
                const quicklaunchresponse = await fetch(CONTENT_ROOT + "quicklaunch.md", { cache: "no-store"});
                if (!quicklaunchresponse.ok) throw new Error(`Could not fetch quicklaunch.md`);

                const quicklaunchmarkdown = await quicklaunchresponse.text();
                // Render Markdown using Marked.js
                quicklaunchDiv.innerHTML = marked.parse(quicklaunchmarkdown);
                quicklaunchDiv.style.display = "block";
            } catch (err) {
                console.log(err);
                quicklaunchDiv.style.display = "none";
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const renderer = new marked.Renderer();

            // Resolve Image paths manually
            renderer.image = ({ href, title, text }) => {
                const out = getRelativePagePath(href);
                return `<img src="${CONTENT_REL_DIR}${out}" alt="${text}" title="${title || ''}">`;
            };
    
            // Resolve Link paths manually
            renderer.link = ({ href, title, text }) => {
                if (href.toLowerCase().endsWith('.md') && !href.startsWith('http')) {
                    const out = getRelativePagePath(href);
                    return `<a href="?page=${out}" title="${title || ''}">${text}</a>`;
                }
                // Standard external or non-md links
                return `<a href="${href}" target="_blank">${text}</a>`;
            };

            marked.use({
                renderer,
                gfm: true,
                breaks: true, // Converts \n in paragraphs to <br> (GitHub style)
                headerIds: true,
                mangle: false
            });

            /**
             * Handle browser Back/Forward navigation
             */
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.path) {
                    loadMarkdown(e.state.path, false);
                } else {
                    // Fallback to initial page if state is empty
                    const params = new URLSearchParams(window.location.search);
                    const thePage = initParams.get('page') || INITIAL_PAGE;
                    loadMarkdown(thePage, false);
                }
            });

            loadQuicklaunchBar();

            // Load initial file
            const initParams = new URLSearchParams(window.location.search);
            const initialPage = initParams.get('page') || INITIAL_PAGE;
            loadMarkdown(initialPage, false);
        });

    </script>
</head>
<body>

    <div id="quicklaunch" style="display:none"></div>
    <div id="content">Loading content...</div>
    <div id="navigation" style="display:none"></div>

</body>
</html>

